<!DOCTYPE html>
<html lang="pt-BR">
<head><meta charset="UTF-8"><title>Desafio 2: Sincronização</title><link rel="stylesheet" href="style.css"></head>
<body>
    <div class="container">
        <h1>🛒 Loja Assíncrona</h1>
        
        <div class="info-box">
            <h4>🎯 Objetivo do Treinamento: Waits</h4>
            <p>Esta página simula uma API lenta (atraso de 3 segundos). O desafio é garantir que seu teste aguarde o carregamento dos elementos antes de tentar interagir.</p>
            <small>Dica: Evite <code>Thread.sleep()</code> ou pausas fixas. Use <strong>Explicit Waits</strong> aguardando o loader sumir ou o produto aparecer.</small>
        </div>

        <div class="controls">
            <button id="load-btn" onclick="loadProducts()">🔍 Buscar Produtos</button>
            <button onclick="openFormModal()" style="background: #3498db;">+ Novo Produto</button>
        </div>

        <!-- Feedback Visual de Carregamento -->
        <div id="loader" class="loader"></div>
        
        <!-- Grid de Produtos -->
        <div id="product-grid" class="product-grid">
            <!-- Produtos serão injetados aqui -->
        </div>

        <br><br><a href="dashboard.html">Voltar ao Dashboard</a>
    </div>

    <!-- Estrutura da Modal -->
    <div id="custom-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h3 id="modal-title">Título</h3>
            <p id="modal-msg">Mensagem</p>
            <button onclick="closeModal()">OK</button>
        </div>
    </div>

    <!-- Modal de Cadastro de Produto -->
    <div id="form-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeFormModal()">&times;</span>
            <h3>Novo Produto</h3>
            <input type="text" id="new-name" placeholder="Nome do Produto">
            <input type="number" id="new-price" placeholder="Preço (R$)">
            <input type="number" id="new-stock" placeholder="Quantidade em Estoque">
            <button onclick="addProduct()" style="background: #3498db; margin-top: 10px;">Salvar</button>
        </div>
    </div>

    <script>
        // Proteção de Rota
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = 'index.html';
        }

        async function loadProducts() {
            const grid = document.getElementById('product-grid');
            const loader = document.getElementById('loader');
            
            // Reset UI
            grid.innerHTML = '';
            loader.style.display = 'block'; // Mostra spinner

            try {
                const response = await fetch('http://localhost:3000/api/products?delay=3000');
                const products = await response.json();
                
                loader.style.display = 'none'; // Esconde spinner

                products.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'product-card';
                    const disabledAttr = item.stock === 0 ? 'disabled' : '';
                    const btnText = item.stock === 0 ? 'Sem Estoque' : 'Comprar';
                    
                    card.innerHTML = `
                        <h3>${item.name}</h3>
                        <p>R$ ${item.price}</p>
                        <small>Estoque: ${item.stock}</small><br><br>
                        <button class="buy-btn" ${disabledAttr}>${btnText}</button>
                    `;
                    grid.appendChild(card);
                });
            } catch (error) { 
                loader.style.display = 'none';
                grid.innerHTML = '<p style="color:red">Erro ao conectar com o servidor. O backend está rodando?</p>'; 
            }
        }

        async function addProduct() {
            const name = document.getElementById('new-name').value;
            const price = parseFloat(document.getElementById('new-price').value);
            const stock = parseInt(document.getElementById('new-stock').value);

            if (!name || isNaN(price) || isNaN(stock)) {
                showModal("Atenção", "Preencha todos os campos!", false);
                return;
            }

            try {
                const response = await fetch('http://localhost:3000/api/products', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, price, stock })
                });

                if (response.ok) {
                    closeFormModal(); // Fecha o formulário antes de mostrar o sucesso
                    showModal("Sucesso", "Produto adicionado!", true);
                    loadProducts(); // Recarrega a lista
                    // Limpar campos
                    document.getElementById('new-name').value = '';
                    document.getElementById('new-price').value = '';
                    document.getElementById('new-stock').value = '';
                } else {
                    closeFormModal(); // Fecha o formulário também em caso de erro da API
                    showModal("Erro", "Erro ao salvar produto.", false);
                }
            } catch (error) {
                console.error(error);
                closeFormModal(); // Fecha o formulário em caso de erro de conexão
                showModal("Erro", "Erro de conexão.", false);
            }
        }

        // Funções da Modal
        function showModal(title, message, isSuccess) {
            const titleElem = document.getElementById('modal-title');
            titleElem.innerText = title;
            titleElem.style.color = isSuccess ? '#27ae60' : '#e74c3c';
            document.getElementById('modal-msg').innerText = message;
            document.getElementById('custom-modal').style.display = 'block';
        }
        function closeModal() { document.getElementById('custom-modal').style.display = 'none'; }
        
        // Funções da Modal de Formulário
        function openFormModal() { document.getElementById('form-modal').style.display = 'block'; }
        function closeFormModal() { document.getElementById('form-modal').style.display = 'none'; }

        // Fecha as modais se clicar fora delas
        window.onclick = function(event) { 
            const customModal = document.getElementById('custom-modal');
            const formModal = document.getElementById('form-modal');
            
            if (event.target == customModal) closeModal();
            if (event.target == formModal) closeFormModal();
        }
    </script>
</body></html>
